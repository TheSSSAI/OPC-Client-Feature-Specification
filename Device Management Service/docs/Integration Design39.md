# 1 Integration Specifications

## 1.1 Extraction Metadata

| Property | Value |
|----------|-------|
| Repository Id | REPO-SVC-DVM |
| Extraction Timestamp | 2024-07-27T10:15:00Z |
| Mapping Validation Score | 100% |
| Context Completeness Score | 95% |
| Implementation Readiness Level | High |

## 1.2 Relevant Requirements

### 1.2.1 Requirement Id

#### 1.2.1.1 Requirement Id

REQ-1-082

#### 1.2.1.2 Requirement Text

The system must provide a secure, token-based mechanism for provisioning new OPC Core Client instances.

#### 1.2.1.3 Validation Criteria

- A one-time use provisioning token can be generated by an administrator.
- An unprovisioned client can use the token to authenticate and receive a unique client certificate.
- The token becomes invalid after first use or expiry.

#### 1.2.1.4 Implementation Implications

- Implement a REST endpoint (e.g., POST /api/v1/clients/provision-token) to generate and persist a secure, single-use token with an expiry.
- Implement a public-facing, token-secured endpoint (e.g., POST /provision/register) for clients to submit a Certificate Signing Request (CSR).
- The service must act as a Certificate Authority (CA) or proxy to a CA to sign the client's CSR and return a valid certificate.

#### 1.2.1.5 Extraction Reasoning

This is a primary, explicitly mapped requirement for the Device Management Service, detailed in its description and visually specified in User Story US-068 (and the underlying sequence diagrams).

### 1.2.2.0 Requirement Id

#### 1.2.2.1 Requirement Id

REQ-1-010

#### 1.2.2.2 Requirement Text

The system must use MQTT for command and control and gRPC for high-volume data.

#### 1.2.2.3 Validation Criteria

- Configuration and software update commands are sent from the central plane to edge clients via MQTT.
- Clients report health and status back to the central plane via MQTT.
- MQTT communication must be secure (TLS) and reliable (QoS 1).

#### 1.2.2.4 Implementation Implications

- The service must implement a persistent MQTT client within a background service (IHostedService).
- Business logic must be implemented to publish command messages to specific, tenant-isolated topics (e.g., tenants/{tenantId}/clients/{clientId}/commands).
- The service must subscribe to status topics to receive and process heartbeats, health metrics, and command acknowledgements from the client fleet.

#### 1.2.2.5 Extraction Reasoning

This requirement defines the core communication pattern for the service. It is explicitly mapped in the repository definition and is the central mechanism in user stories like US-051 and US-053.

### 1.2.3.0 Requirement Id

#### 1.2.3.1 Requirement Id

REQ-1-062

#### 1.2.3.2 Requirement Text

The system shall provide a centralized fleet management capability for all connected OPC Core Clients.

#### 1.2.3.3 Validation Criteria

- An administrator can view the status (online/offline, health) of all clients.
- An administrator can remotely trigger a configuration update for a specific client or group of clients.

#### 1.2.3.4 Implementation Implications

- The service must expose a REST API (e.g., GET /api/v1/clients) to provide a consolidated view of the client fleet's status.
- The service must provide an API endpoint to initiate a configuration update, which translates the request into an MQTT command message.
- The underlying database schema must track the current state, configuration version, and health metrics for each registered client device.

#### 1.2.3.5 Extraction Reasoning

This is a key business requirement mapped to the repository. The service's entire purpose is to be the backend implementation for this capability, as detailed in user stories US-050 and US-051.

### 1.2.4.0 Requirement Id

#### 1.2.4.1 Requirement Id

REQ-1-064

#### 1.2.4.2 Requirement Text

The system must provide a mechanism for securely and remotely updating the software of an OPC Core Client.

#### 1.2.4.3 Validation Criteria

- An administrator can initiate a software update for a client, specifying the target version (Docker image tag).
- The client must report the status (success, failure, rollback) of the update process.

#### 1.2.4.4 Implementation Implications

- Implement an API endpoint to trigger the update, which creates and publishes a signed command message over MQTT.
- The MQTT message payload must contain the new Docker image URI and a checksum for verification.
- The service must process status messages from the client to track the update's progress and final outcome in the database.

#### 1.2.4.5 Extraction Reasoning

This is a critical operational requirement mapped to the repository. User Story US-053 provides a complete technical specification for this flow, with this service acting as the initiator.

## 1.3.0.0 Relevant Components

- {'component_name': 'Device Management Service', 'component_specification': 'Manages the entire lifecycle of distributed OPC Core Client instances, including secure provisioning, remote configuration and software updates, and health/status monitoring. Acts as the central command and control hub for the edge device fleet.', 'implementation_requirements': ['Must be a stateless .NET 8 microservice.', 'Must maintain a persistent connection to the MQTT broker as a background service.', 'Must provide REST APIs for the frontend to manage the client fleet.', 'Must handle asynchronous communication with potentially offline devices.'], 'architectural_context': "Belongs to the 'Application Services Layer'. It implements business logic for a specific domain (device fleet management) and interacts with data persistence and messaging layers.", 'extraction_reasoning': "This is the primary component being defined by the 'REPO-SVC-DVM' repository. The name and responsibilities directly match the architecture documentation."}

## 1.4.0.0 Architectural Layers

- {'layer_name': 'Application Services Layer (Microservices)', 'layer_responsibilities': 'Implements the core business logic and domain functionality of the Central Management Plane. Each service owns a specific business capability, is independently deployable, and communicates via well-defined APIs.', 'layer_constraints': ['Services should be stateless to facilitate horizontal scaling.', 'Services must enforce tenant data isolation.', 'Communication between services should be via synchronous (gRPC/REST) or asynchronous (messaging) patterns.'], 'implementation_patterns': ['Domain-Driven Design (DDD)', 'Microservices Architecture', 'REST and gRPC for APIs', 'Containerization (Docker)'], 'extraction_reasoning': "The 'REPO-SVC-DVM' repository is explicitly defined as a microservice that resides within this architectural layer, adhering to its principles and responsibilities."}

## 1.5.0.0 Dependency Interfaces

### 1.5.1.0 Interface Name

#### 1.5.1.1 Interface Name

EF Core DbContext (Device Management)

#### 1.5.1.2 Source Repository

REPO-DB-POSTGRES

#### 1.5.1.3 Method Contracts

##### 1.5.1.3.1 Method Name

###### 1.5.1.3.1.1 Method Name

DbSet<OpcCoreClient>.FindAsync()

###### 1.5.1.3.1.2 Method Signature

ValueTask<OpcCoreClient> FindAsync(object[] keyValues, CancellationToken cancellationToken)

###### 1.5.1.3.1.3 Method Purpose

To retrieve a specific OPC Core Client entity by its primary key for read or update operations.

###### 1.5.1.3.1.4 Integration Context

Called when handling API requests for a specific client, such as GET /api/v1/clients/{id}.

##### 1.5.1.3.2.0 Method Name

###### 1.5.1.3.2.1 Method Name

DbSet<OpcCoreClient>.Where()

###### 1.5.1.3.2.2 Method Signature

IQueryable<OpcCoreClient> Where(Expression<Func<OpcCoreClient, bool>> predicate)

###### 1.5.1.3.2.3 Method Purpose

To query for a set of client entities based on criteria, such as fetching all clients for a specific tenant.

###### 1.5.1.3.2.4 Integration Context

Called when providing a list of all devices for the fleet management UI (GET /api/v1/clients).

##### 1.5.1.3.3.0 Method Name

###### 1.5.1.3.3.1 Method Name

DbSet<ProvisioningToken>.FindAsync()

###### 1.5.1.3.3.2 Method Signature

ValueTask<ProvisioningToken> FindByHashAsync(string tokenHash)

###### 1.5.1.3.3.3 Method Purpose

To retrieve a provisioning token by its hash during the client registration process.

###### 1.5.1.3.3.4 Integration Context

Called when a new client attempts to register itself using a one-time token.

#### 1.5.1.4.0.0 Integration Pattern

Repository Pattern over EF Core

#### 1.5.1.5.0.0 Communication Protocol

SQL over TCP/IP

#### 1.5.1.6.0.0 Extraction Reasoning

The service needs to persist and manage the state of registered client devices and provisioning tokens, making the PostgreSQL database a critical dependency as defined in the repository's contracts and database schema.

### 1.5.2.0.0.0 Interface Name

#### 1.5.2.1.0.0 Interface Name

IMqttClient

#### 1.5.2.2.0.0 Source Repository

REPO-MSG-MQTT

#### 1.5.2.3.0.0 Method Contracts

##### 1.5.2.3.1.0 Method Name

###### 1.5.2.3.1.1 Method Name

PublishAsync

###### 1.5.2.3.1.2 Method Signature

Task<MqttClientPublishResult> PublishAsync(MqttApplicationMessage message, CancellationToken cancellationToken)

###### 1.5.2.3.1.3 Method Purpose

To send a command message (e.g., configuration update, software update) to a specific topic on the MQTT broker.

###### 1.5.2.3.1.4 Integration Context

Called after an administrator triggers an action from the UI, such as clicking 'Update Configuration' (US-051).

##### 1.5.2.3.2.0 Method Name

###### 1.5.2.3.2.1 Method Name

SubscribeAsync

###### 1.5.2.3.2.2 Method Signature

Task<MqttClientSubscribeResult> SubscribeAsync(MqttTopicFilter topicFilter, CancellationToken cancellationToken)

###### 1.5.2.3.2.3 Method Purpose

To listen for incoming status and health messages from the fleet of OPC Core Clients.

###### 1.5.2.3.2.4 Integration Context

Called once on service startup within the background service to establish subscriptions to topics like 'tenants/+/clients/+/status'. Scalability will be achieved using MQTT v5 Shared Subscriptions.

#### 1.5.2.4.0.0 Integration Pattern

Publish-Subscribe Client

#### 1.5.2.5.0.0 Communication Protocol

MQTT v5 over TLS

#### 1.5.2.6.0.0 Extraction Reasoning

This is the primary dependency for asynchronous communication with the edge devices. The repository definition and multiple user stories confirm this publish-subscribe interaction model.

## 1.6.0.0.0.0 Exposed Interfaces

### 1.6.1.0.0.0 Interface Name

#### 1.6.1.1.0.0 Interface Name

IDeviceManagementService (REST API)

#### 1.6.1.2.0.0 Consumer Repositories

- REPO-GW-API

#### 1.6.1.3.0.0 Method Contracts

##### 1.6.1.3.1.0 Method Name

###### 1.6.1.3.1.1 Method Name

GetClients

###### 1.6.1.3.1.2 Method Signature

GET /api/v1/clients

###### 1.6.1.3.1.3 Method Purpose

Retrieves a list of all registered OPC Core Clients for the current tenant, including their status and version.

###### 1.6.1.3.1.4 Implementation Requirements

Must query the PostgreSQL database and return a DTO containing client metadata. Must enforce tenant isolation based on the JWT claims.

##### 1.6.1.3.2.0 Method Name

###### 1.6.1.3.2.1 Method Name

GenerateProvisioningToken

###### 1.6.1.3.2.2 Method Signature

POST /api/v1/clients/provision-token

###### 1.6.1.3.2.3 Method Purpose

Generates a new, single-use provisioning token for bootstrapping a new OPC Core Client.

###### 1.6.1.3.2.4 Implementation Requirements

Must generate a cryptographically secure random string, hash it, store the hash in the database with an expiry, and return the plaintext token to the administrator, as per US-068.

##### 1.6.1.3.3.0 Method Name

###### 1.6.1.3.3.1 Method Name

UpdateClientConfiguration

###### 1.6.1.3.3.2 Method Signature

POST /api/v1/clients/{id}/config

###### 1.6.1.3.3.3 Method Purpose

Initiates a remote configuration update for a specified client.

###### 1.6.1.3.3.4 Implementation Requirements

Must validate the request, persist the new configuration state, and publish a 'UpdateConfiguration' command to the client's specific MQTT topic, as per US-051.

##### 1.6.1.3.4.0 Method Name

###### 1.6.1.3.4.1 Method Name

UpdateClientSoftware

###### 1.6.1.3.4.2 Method Signature

POST /api/v1/clients/{id}/software-update

###### 1.6.1.3.4.3 Method Purpose

Initiates a remote software update for a specified client.

###### 1.6.1.3.4.4 Implementation Requirements

Must validate the request and publish an 'UpdateSoftware' command over MQTT with the target Docker image details, as per US-053.

##### 1.6.1.3.5.0 Method Name

###### 1.6.1.3.5.1 Method Name

RollbackClientSoftware

###### 1.6.1.3.5.2 Method Signature

POST /api/v1/clients/{id}/rollback

###### 1.6.1.3.5.3 Method Purpose

Initiates a remote software rollback for a specified client.

###### 1.6.1.3.5.4 Implementation Requirements

Must verify a previous version exists, and publish a 'RollbackSoftware' command over MQTT, as per US-055.

#### 1.6.1.4.0.0 Service Level Requirements

- P95 latency for all GET requests should be < 200ms.
- POST requests should return '202 Accepted' within 100ms to acknowledge asynchronous operations.

#### 1.6.1.5.0.0 Implementation Constraints

- All endpoints must be secured and require a valid JWT with the 'Administrator' role.
- The service must perform authorization checks to ensure the user has permission to manage devices.

#### 1.6.1.6.0.0 Extraction Reasoning

This interface is the primary synchronous entry point for the frontend (via the API Gateway) to manage and monitor the device fleet. User stories US-068, US-051, US-053, and US-055 all show the frontend initiating actions via this API.

### 1.6.2.0.0.0 Interface Name

#### 1.6.2.1.0.0 Interface Name

IProvisioningService (Public REST API)

#### 1.6.2.2.0.0 Consumer Repositories

- REPO-EDG-OPC

#### 1.6.2.3.0.0 Method Contracts

- {'method_name': 'RegisterClient', 'method_signature': 'POST /provision/register', 'method_purpose': 'Allows an unprovisioned OPC Core Client to exchange a one-time token for a long-term client certificate.', 'implementation_requirements': 'This endpoint must be public but secured by the single-use token. It accepts a Certificate Signing Request (CSR) and returns a signed X.509 certificate.'}

#### 1.6.2.4.0.0 Service Level Requirements

- P95 latency should be < 500ms.

#### 1.6.2.5.0.0 Implementation Constraints

- This endpoint must not require a JWT, as the client is not yet authenticated.
- The endpoint must be protected by aggressive rate limiting at the API Gateway to prevent abuse.
- The token validation logic must be constant-time to prevent timing attacks.

#### 1.6.2.6.0.0 Extraction Reasoning

This special-purpose, public-facing interface is required to fulfill the secure bootstrapping workflow defined in REQ-1-082 and user story US-068.

### 1.6.3.0.0.0 Interface Name

#### 1.6.3.1.0.0 Interface Name

MQTT Command Publisher

#### 1.6.3.2.0.0 Consumer Repositories

- REPO-EDG-OPC

#### 1.6.3.3.0.0 Method Contracts

- {'method_name': 'Publish Command', 'method_signature': 'N/A (Behavioral Contract)', 'method_purpose': "Publishes various command messages to the topic 'tenants/{tenantId}/clients/{clientId}/commands'.", 'implementation_requirements': "The service must define and serialize payload schemas (defined in REPO-LIB-SHARED) for commands like 'UpdateConfiguration', 'UpdateSoftware', 'RequestLogs', and 'RollbackSoftware'. Messages must be published with QoS 1 for reliable delivery."}

#### 1.6.3.4.0.0 Service Level Requirements

- Commands must be published to the MQTT broker within 50ms of the corresponding API call acknowledgement.

#### 1.6.3.5.0.0 Implementation Constraints

- The topic structure must be strictly followed to ensure multi-tenancy and security.
- Message payloads should be versioned to support client compatibility.

#### 1.6.3.6.0.0 Extraction Reasoning

This exposed behavior is the core mechanism for controlling edge devices. It's consumed by all OPC Core Clients and is a critical part of the system's asynchronous, distributed architecture.

## 1.7.0.0.0.0 Technology Context

### 1.7.1.0.0.0 Framework Requirements

The service must be built using .NET 8 and ASP.NET Core 8 for the REST API. Data persistence must be implemented with Entity Framework Core 8.

### 1.7.2.0.0.0 Integration Technologies

- Npgsql.EntityFrameworkCore.PostgreSQL v8.0.4 for database connectivity.
- MQTTnet v4.3.6 for implementing the MQTT client.

### 1.7.3.0.0.0 Performance Constraints

Must be able to handle and process status updates from up to 10,000 concurrently connected clients, implying efficient MQTT message handling and batch database updates if necessary.

### 1.7.4.0.0.0 Security Requirements

Must validate the client identity from MQTT messages, likely based on the client certificate's Common Name (CN) matching the registered client ID. All API endpoints must be protected via JWT validation.

## 1.8.0.0.0.0 Extraction Validation

| Property | Value |
|----------|-------|
| Mapping Completeness Check | All repository mappings for requirements, componen... |
| Cross Reference Validation | All requirements are cross-referenced and validate... |
| Implementation Readiness Assessment | The context is highly implementation-ready. It spe... |
| Quality Assurance Confirmation | Systematic analysis confirms zero contradictions b... |

