#
# API Gateway Configuration: Ingress for API Documentation
#
# This Ingress resource defines the public endpoint for accessing the aggregated OpenAPI specification.
# It is a special route that applies the openapi-aggregation plugin.
#
# Applied Policies (Plugins):
# - cors-policy: Allows the documentation to be accessed from various origins.
# - openapi-aggregation: The core plugin that generates the unified spec.
# - global-rate-limiting: Protects the endpoint from abuse.
#
# NOTE: This route intentionally OMITS the `global-jwt-validation` plugin, as API documentation
# is often intended to be publicly accessible or use a different authentication scheme (e.g., API key).
#
# Requirements Fulfilled: REQ-1-086 (Expose OpenAPI Spec)
#
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: docs-ingress
  namespace: industrial-edge-api-gateway
  annotations:
    # Specifies that Kong should handle this Ingress resource.
    kubernetes.io/ingress.class: kong
    # Instructs Kong to strip the matched path prefix before forwarding.
    konghq.com/strip-path: "true"
    # Applies plugins for documentation exposure.
    konghq.com/plugins: cors-policy, openapi-aggregation, global-rate-limiting
spec:
  tls:
    - hosts:
        # This is a placeholder and MUST be patched by environment-specific overlays.
        - api.placeholder.local
      # This secret name is a placeholder and MUST be patched by overlays.
      secretName: api-tls-cert
  rules:
    - host: api.placeholder.local # Placeholder, patched by overlays.
      http:
        paths:
          - path: /api/docs
            pathType: Prefix
            backend:
              # The Ingress spec requires a backend, but the openapi plugin handles the response.
              # We route to a valid but minimal service, often the gateway itself or a placeholder.
              # For simplicity, we can route it to a service that will return a 404, which is fine
              # as the plugin intercepts the request before it reaches the backend.
              service:
                name: iam-service # A valid service name is required for Ingress validation
                port:
                  number: 80